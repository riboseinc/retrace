#!/bin/bash

readonly __progname="$(basename $0)"

errx() {
	echo -e "${__progname}: $@" >&2
	exit 1
}

usage() {
	echo "usage: ${__progname} <executable>"
	exit 1
}

get_lib_file() {
    local fname="$1"

    # check for the local file
    local path="$fname"
    if [[ -f "$path" ]]; then
        output="$path"
        return 0
    fi

    # check in autotools generated dir
    local path=".libs/$fname"
    if [[ -f "$path" ]]; then
        output="$path"
        return 0
    fi

    # check in the PREFIX path
    local path="@libdir@/$fname"
    if [[ -f "$path" ]]; then
        output="$path"
        return 0
    fi

    # check default library path
    local path="/usr/lib/$fname"
    if [[ -f "$path" ]]; then
        output="$path"
        return 0
    fi

    # check default library path
    local path="/usr/lib64/$fname"
    if [[ -f "$path" ]]; then
        output="$path"
        return 0
    fi

    return 1
}


main() {
	[ -z "$1" ] && \
		usage

	if [[ "${RETRACE_CONFIG}" ]]; then
		readonly local config="${RETRACE_CONFIG}"

		[ ! -f "${config}" ] && \
			errx "cannot open '${config}'"
	fi

	if $(uname | grep -q ^Darwin); then
		readonly lib="./retrace.dylib"
        get_lib_file "$lib"
        if [ $? != 0 ]; then
            errx "Cannot find '${lib}'"
        fi

		DYLD_FORCE_FLAT_NAMESPACE=1 DYLD_INSERT_LIBRARIES="${output}" "$@"
	else
		readonly lib="retrace.so"
        get_lib_file "$lib"
        if [ $? != 0 ]; then
            errx "Cannot find '${lib}'"
        fi

		LD_PRELOAD="${output}" "$@"
	fi
}

main "$@"

exit $?
