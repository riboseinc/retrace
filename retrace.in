#!/bin/sh

readonly __progname="$(basename $0)"

errx() {
	echo "${__progname}: $@" >&2
	exit 1
}

usage() {
	echo "usage: ${__progname} [-f configuration file location] <executable>"
	exit 1
}

get_lib_file() {
	readonly local fname="$1"

	for path in "${fname}" \
	    ".libs/${fname}" \
	    "../.libs/${fname}" \
	    "@libdir@/${fname}" \
	    "/usr/lib/${fname}" \
	    "/usr/lib64/${fname}"; do
		[ ! -f "${path}" ] && \
			continue

		echo "${path}"

		return 0
	done

	return 1
}

main() {
	[ $# -lt 1  ] && \
		usage

	if [ $# -ge 3 -a "$1" = "-f" ]; then
		local RETRACE_CONFIG="$2"

		shift 2
	fi

	if [ "${RETRACE_CONFIG}" ]; then
		[ ! -f "${RETRACE_CONFIG}" ] && \
			errx "cannot open '${RETRACE_CONFIG}'"
	fi

	readonly local libname="libretrace"

	if $(uname | grep -q ^Darwin); then
		readonly local lib="${libname}.dylib"
		readonly local output=$(get_lib_file "${lib}")
		readonly local envload="RETRACE_CONFIG=${RETRACE_CONFIG} DYLD_FORCE_FLAT_NAMESPACE=1 DYLD_INSERT_LIBRARIES=${output}"
	else
		readonly local lib="${libname}.so"
		readonly local output=$(get_lib_file "${lib}")
		readonly local envload="RETRACE_CONFIG=${RETRACE_CONFIG} LD_PRELOAD=${output}"
	fi

	[ ! "${output}" ] && \
		errx "cannot find '${lib}'"

	[ ! -x "$1" ] && \
		errx "cannot execute '$1'"

	eval "${envload}" "$@"
}

main "$@"

exit $?
